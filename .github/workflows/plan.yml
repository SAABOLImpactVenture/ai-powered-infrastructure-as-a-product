name: plan

on:
  push:
    branches: [ "main" ]
    paths:
      - "**/*.tf"
      - "**/*.tfvars"
      - "terraform/**"
      - "platform/**"
  pull_request:
    branches: [ "main" ]
    paths:
      - "**/*.tf"
      - "**/*.tfvars"
      - "terraform/**"
      - "platform/**"

jobs:
  plan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Detect Terraform changes
        id: changed
        run: |
          set -euo pipefail
          echo "changed=false" >> "$GITHUB_OUTPUT"
          # Determine a base to diff against (PR base or previous commit)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base_sha="${{ github.event.pull_request.base.sha }}"
          else
            base_sha="$(git rev-parse HEAD^ 2>/dev/null || echo '')"
          fi
          if [ -n "$base_sha" ]; then
            if git diff --name-only "$base_sha" HEAD | grep -E '\.tf$|\.tfvars$|^terraform/|^platform/' >/dev/null; then
              echo "changed=true" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Terraform fmt (offline)
        if: steps.changed.outputs.changed == 'true'
        run: terraform fmt -check -recursive || true

      - name: Terraform validate (offline)
        if: steps.changed.outputs.changed == 'true'
        run: |
          terraform init -backend=false || true
          terraform validate || true

      - name: Summary
        run: echo "âœ… plan: completed (offline, non-blocking)" | tee -a "$GITHUB_STEP_SUMMARY"
