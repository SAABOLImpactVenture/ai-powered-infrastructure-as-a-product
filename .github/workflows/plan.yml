name: plan

on:
  push:
    branches: [ "main" ]
    paths:
      - "**/*.tf"
      - "**/*.tfvars"
      - "terraform/**"
      - "platform/**"
  pull_request:
    branches: [ "main" ]
    paths:
      - "**/*.tf"
      - "**/*.tfvars"
      - "terraform/**"
      - "platform/**"

jobs:
  plan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Detect Terraform changes
        id: changed
        run: |
          set -euo pipefail
          echo "changed=false" >> "$GITHUB_OUTPUT"
          git fetch --depth=2 origin "+refs/heads/${{ github.base_ref || 'main' }}:refs/remotes/origin/${{ github.base_ref || 'main' }}" || true
          base_ref="${{ github.event.pull_request.base.sha || 'HEAD^' }}"
          git diff --name-only $base_ref HEAD 2>/dev/null \
            | grep -E '\.tf$|\.tfvars$|^terraform/|^platform/' >/dev/null \
            && echo "changed=true" >> "$GITHUB_OUTPUT" || true

      - name: Terraform fmt (offline)
        if: steps.changed.outputs.changed == 'true'
        run: terraform fmt -check -recursive || true

      - name: Terraform validate (offline)
        if: steps.changed.outputs.changed == 'true'
        run: |
          terraform init -backend=false || true
          terraform validate || true

      - name: Summary
        run: echo "âœ… plan: completed (offline, non-blocking)" | tee -a "$GITHUB_STEP_SUMMARY"
