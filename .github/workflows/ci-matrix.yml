name: ci-matrix
on:
  pull_request:
  workflow_dispatch:
permissions:
  contents: read
  id-token: write
concurrency: ci-${{ github.workflow }}-${{ github.ref }}

jobs:
  terraform-validate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        path:
          - platform/azure/observability/log_analytics
          - workloads/iaap/modules/aws/networking
          - platform/gcp/audit/log_sink
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.8.6 }
      - name: Init & Validate (read-only; no backend)
        working-directory: ${{ matrix.path }}
        run: |
          terraform init -input=false -backend=false
          terraform validate -no-color

  iac-policy-gates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup tflint (pinned)
        uses: terraform-linters/setup-tflint@v4
        with: { tflint_version: v0.53.0 }
      - name: Run tflint (fail on problems)
        run: |
          tflint --init
          tflint -f compact
      - name: Checkov (Terraform/Kubernetes/Helm)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          soft_fail: false
          framework: terraform,kubernetes,helm
      - name: Conftest policy gate (OPA)
        run: conftest test --policy policy/ .
