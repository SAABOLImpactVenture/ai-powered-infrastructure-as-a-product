name: SBOM & Cosign Attestation

on:
  push:
    branches: [ main ]
  pull_request:
    paths:
      - '**/*'
      - '.github/workflows/sbom-and-attest.yml'

permissions:
  id-token: write
  contents: read

jobs:
  sbom-and-attest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft version

      - name: Generate SBOM (SPDX JSON) for repo
        run: |
          syft dir:. -o spdx-json > sbom.spdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-spdx-json
          path: sbom.spdx.json

      - name: Install cosign
        uses: sigstore/cosign-installer@v3.6.0

      - name: Cosign attest SBOM (keyless, blob)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          # Create DSSE-style attestation for the SBOM blob
          cosign attest-blob --yes             --predicate sbom.spdx.json             --type spdxjson             sbom.spdx.json             --output-file sbom.spdx.json.att

      - name: Upload attestation artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-attestation
          path: sbom.spdx.json.att
