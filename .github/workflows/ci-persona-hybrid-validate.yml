name: Hybrid Persona Framework Validation

on:
  push:
    branches: [main, trunk]
  pull_request:
    branches: [main, trunk]

jobs:
  lint-yaml-json:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Basic YAML readability
        run: |
          python - << 'EOF'
          import os, sys
          root = "."
          for dirpath, _, filenames in os.walk(root):
              for name in filenames:
                  if name.endswith((".yml", ".yaml")):
                      path = os.path.join(dirpath, name)
                      with open(path, "r", encoding="utf-8") as f:
                          _ = f.read()
          EOF
      - name: JSON validation
        run: |
          python - << 'EOF'
          import os, sys, json
          root = "."
          for dirpath, _, filenames in os.walk(root):
              for name in filenames:
                  if name.endswith(".json"):
                      path = os.path.join(dirpath, name)
                      with open(path, "r", encoding="utf-8") as f:
                          try:
                              json.load(f)
                          except Exception as exc:
                              print(f"JSON validation failed for {path}: {exc}")
                              sys.exit(1)
          EOF

  terraform-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Terraform
        run: |
          curl -fsSL https://releases.hashicorp.com/terraform/1.9.5/terraform_1.9.5_linux_amd64.zip -o terraform.zip
          sudo unzip terraform.zip -d /usr/local/bin
          terraform version
      - name: Terraform fmt and validate
        run: |
          if [ -d "iac/modules/secure-storage" ]; then
            find iac -type f -name "*.tf" -print0 | xargs -0 -r terraform fmt -check
            terraform -chdir=iac/modules/secure-storage init -backend=false
            terraform -chdir=iac/modules/secure-storage validate
          else
            echo "iac/modules/secure-storage not present yet; skipping validation."
          fi

  python-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        working-directory: skills/semantic-kernel/python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run pytest
        working-directory: skills/semantic-kernel/python
        run: pytest -q

  oscal-verify:
    runs-on: ubuntu-latest
    needs: python-tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install jsonschema
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema
      - name: Verify OSCAL documents if present
        run: |
          python - << 'EOF'
          import os, json
          from jsonschema import validate
          schema = {
              "type": "object",
              "required": ["uuid", "metadata", "results"],
          }
          base = "artifacts/evidence/oscal"
          if not os.path.isdir(base):
              print("No OSCAL documents present; skipping.")
          else:
              for name in os.listdir(base):
                  if name.endswith(".json"):
                      path = os.path.join(base, name)
                      with open(path, "r", encoding="utf-8") as f:
                          doc = json.load(f)
                      validate(instance=doc, schema=schema)
                      print(f"Validated OSCAL document: {path}")
          EOF

  evidence-summary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Evidence summary
        run: |
          if [ -d "artifacts/evidence" ]; then
            echo "Evidence files:"
            find artifacts/evidence -type f -print || true
          else
            echo "No evidence directory yet."
          fi
