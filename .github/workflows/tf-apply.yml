name: tf-apply
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  apply:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
      - name: Guard - manual only
        if: ${{ github.event_name != 'workflow_dispatch' }}
        run: |
          echo "::error ::Apply is only allowed via workflow_dispatch (manual run)."
          exit 1
      - name: Terraform Init (placeholder)
        run: |
          TF_DIR="${TF_DIR:-infra}"
          if [ -d "$TF_DIR" ]; then
            terraform -chdir="$TF_DIR" init -upgrade
          else
            echo "No $TF_DIR directory; skipping." ; exit 0
          fi
      - name: Terraform Apply (placeholder)
        run: |
          echo "Configure backend + OIDC cloud auth before enabling real apply."
          exit 0
